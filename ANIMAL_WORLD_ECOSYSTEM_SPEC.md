# 🦌 animal_world_emergent 生态系统模拟项目：综合集成规格说明书

## 0. 项目概述
`animal_world_emergent` 是一个多 Agent 协作的自主生态模拟系统。该系统通过模拟土壤养分循环、植被生长、食草动物（绵羊）与食肉动物（老虎）之间的动态博弈，旨在探索复杂生态系统中的突现性（Emergent）行为。

## 1. 核心运行协议 (Integration Protocol)

### 1.1 空间坐标系规范
*   **坐标标准**：统一使用**整数网格坐标 (x, y)** 进行 Agent 间的数据交换。
*   **坐标原点**：左下角为 (0,0)，至 (width-1, height-1)@
*   **草地特殊处理**：草地内部计算可使用浮点坐标，但与外部交互时必须映射至最近的整数网格。

### 1.2 模拟主循环顺序 (Synchronous Execution)
1.  **Ground (土壤)**：`step()` - 更新土壤条件，计算自然养分流失。
2.  **Grass (草地)**：`step(global_state)` - 根据当前位置的养分和水分计算生长，更新生物量。
3.  **Sheep (绵羊)**：`step(global_state)` - 基于草地密度避开老虎进行移动和啃食。
4.  **Tiger (老虎)**：`step(global_state)` - 根据绵羊位置进行狩猎或领地巡逻。
5.  **Ground (反馈)**：`receive_feedback()` - 接收绵羊排泄物、草地凋落物及老虎留下的尸体残余，完成养分循环。

### 1.3 数据交换格式
*   **协议载体**：JSON 序列化的 Python 字典。
*   **2D 数组布局**：统一使用 **行主序 (Row-Major)**，即 `[height][width]` 或 `(row, col)`。
*   **无效值**：使用 `None` 或忽略键名，严禁使用 0 作为占位符以免混淆地理数据。

---

## 2. 模块详细规格 (Module Specifications)

### 2.1 土壤模块 (Ground Module) - “万物之母”
负责养分循环、地形定义及全局状态验证。
*   **核心数据 (SoilCell)**：包含氮、磷、钾养分含量、含水量 (0-1.0)、pH 值、有机质、海拔高度。
*   **输入接口**：
    *   `receive_waste_deposit`: 接收绵羊的有机排泄物。
    *   `receive_carcass_decomposition`: 接收捕食后留下的生物量反馈。
    *   `consume_nutrients`: 植物生长时的养分消耗。
*   **输出接口**：提供全局地形图（坡度、水源地、障碍物）和养分热力图。

### 2.2 草地模块 (Grass Module) - “基础生产者”
模拟植被的生物量累积与恢复力。
*   **核心逻辑**：
    *   `biomass`: 当前生物量 (kg/m²)。
    *   `resilience_factor`: 恢复力，受过度啃食频率影响。
*   **输入接口**：从全局状态获取特定坐标的 `nitrogen` 和 `moisture`。
*   **输出接口**：
    *   `biomass_grid`: 2D 生物量矩阵，供绵羊决策。
    *   `nutritional_info`: 蛋白质与纤维含量，影响动物能量转换效率。

### 2.3 绵羊模块 (Sheep Module) - “中层转化者”
*   **状态维护**：位置、能量、健康度、警觉度。
*   **行为逻辑**：
    *   优先移动至生物量最高的网格。
    *   根据 `tiger_pressure`（老虎位置）计算反方向逃逸矢量。
    *   群体行为：当周围 3 格内绵羊数 $\ge 3$ 时，触发防御奖成。

### 2.4 老虎模块 (Tiger Module) - “顶级捕食者”
*   **状态维护**：位置、能量、狩猎技能、领地范围。
*   **行为逻辑**：
    *   搜索邻近绵羊。
    *   计算捕猎成功率。
    *   **协作模式 (Pack Hunting)**：
        *   2 只及以上老虎共享目标时，成功率 +15%，但能量消耗增加 25%。

---

## 3. 已达成一致的关键参数 (Negotiated Parameters)

基于 `events.jsonl` 中的协商记录，以下参数已确认为系统不变量：

| 参数名称 | 协商数值 | 说明 |
| :--- | :--- | :--- |
| **检测范围 (Detection Range)** | 50.0 单元 | 老虎探测绵羊的最大距离 |
| **基础攻击成功率** | 0.45 | 单独狩猎时的基础概率 |
| **绵羊逃逸奖成** | 0.25 | 绵羊转向/加速逃避的概率提升 |
| **警觉度加权** | 0.3 | 警觉度对被捕食率的负相关影响系数 |
| **群体防御奖成** | 0.2 | $\ge 3$ 只绵羊聚集时提升的生存率 |
| **狩猎能量消耗** | 15.0 | 每次追击尝试消耗的能量 |
| **进食能量增益** | 80.0 | 狩猎成功后补充的能量单位 |
| **受伤概率** | 0.15 | 狩猎失败或激烈对抗导致受伤的几率 |

---

## 4. 非功能性需求 (Quality Attributes)

*   **性能边界**：
    *   每个模块的 `step()` 必须在 **100ms** 内完成。
    *   单帧总计算时延需 **< 500ms**。
    *   每个模块内存占用上限 **100MB**。
*   **扩展支持**：
    *   支持最大 **1000x1000** 规模的网格。
    *   支持 **10,000+** 草地块及 **1000+** 动物个体。
*   **容错处理**：
    *   若草地模块崩溃，系统将回退使用上一时显的生物量快照。
    *   土壤模块由于涉及全局验证，必须保持高可用。

## 5. 开发路线图 (Implementation Roadmap)

1.  **第一阶段：核心接口 (Week 1)** - 完成土壤网格、基础物理生长公式及移动逻辑。
2.  **第二阶段：集成联调 (Week 2)** - 建立全局状态字典映射，实现模块间 JSON 数据流转。
3.  **第三阶段：性能优化 (Week 3)** - 优化空间查询算法，实现高效的捕食者-猎物搜索。
4.  **第四阶段：长期稳定 (Week 4)** - 进行 1000+ 时间步的稳定性测试，观察种群崩溃或平衡。

---
**状态**：协同设计完成 (Finalized Design)
**最后更新**：2026-02-14
**协调 Agent**：ground / grass / sheep / tiger 共识达成
